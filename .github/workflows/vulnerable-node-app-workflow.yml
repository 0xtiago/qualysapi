name: OWASP Vulnerable Node Application - Action workflow examplefor QUALYS WAS API.
on:
  push:
    branches:
      - main
    paths:
      - examples/apps/vulnerable-node-app/**
  pull_request:
    branches: 
      - main
    paths:
      - examples/apps/vulnerable-node-app/**

jobs:
  build:
    runs-on: ubuntu-22.04
    environment: Qualys
    steps:
    - uses: actions/checkout@v3
    - name: Setup Ubuntu Runner
      run: |
        sudo apt update
        sudo apt install -y sudo net-tools wget git curl p7zip-full ca-certificates apt-transport-https software-properties-common pssh python3 python3-pip python-setuptools
        sudo timedatectl set-timezone America/Sao_Paulo
    
    - name: Setup web server (Cloud VPS).
      continue-on-error: true
      env:
        SSH_SERVER: ${{ secrets.SSH_SERVER }}
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_KEY: ${{ secrets.SSH_KEY }}
      run: |
        echo "Deploying SSH Key"
        echo "-----BEGIN OPENSSH PRIVATE KEY-----" > /tmp/server.key
        echo $SSH_KEY | base64 -w0 | base64 --decode | tr " " "\n" | tail -n +5 | head -n-4 >> /tmp/server.key
        echo "-----END OPENSSH PRIVATE KEY-----" >> /tmp/server.key
        sudo chmod 600 /tmp/server.key
        cat /tmp/server.key

        echo "Testing connection calling date command."
        parallel-ssh -H $SSH_USER@$SSH_SERVER -i -x "-i /tmp/server.key -o StrictHostKeyChecking=no" 'date'

        echo "Stop and cleaning last build."
        parallel-ssh -H $SSH_USER@$SSH_SERVER -i -x "-i /tmp/server.key -o StrictHostKeyChecking=no" 'docker kill $(docker ps -q)'
        parallel-ssh -H $SSH_USER@$SSH_SERVER -i -x "-i /tmp/server.key -o StrictHostKeyChecking=no" 'docker system prune -a -f'

        echo "Deploying and buildin vulnerable Node application."
        parallel-ssh -H $SSH_USER@$SSH_SERVER -i -x "-i /tmp/server.key -o StrictHostKeyChecking=no" 'rm -rf NodeGoat'
        parallel-ssh -H $SSH_USER@$SSH_SERVER -i -x "-i /tmp/server.key -o StrictHostKeyChecking=no" 'git clone https://github.com/0xtiago/NodeGoat ; sleep 30'
        parallel-ssh -H $SSH_USER@$SSH_SERVER -i -x "-i /tmp/server.key -o StrictHostKeyChecking=no" 'cd NodeGoat ; docker-compose build && docker-compose up -d ; sleep 30'
        echo "Built and available at port 4000/tcp."

    - name: Configuring qualysapi script and lauching web vulnerability scan. Time to have a coffee, it will take a little long â˜•. 
      env:
        SSH_SERVER: ${{ secrets.SSH_SERVER }}
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_KEY: ${{ secrets.SSH_KEY }} 
        QUALYS_SCANNER_TYPE: ${{ vars.QUALYS_SCANNER_TYPE }}
        QUALYS_URL: ${{ vars.QUALYS_URL }}
        QUALYS_USER: ${{ secrets.QUALYS_USER }}
        QUALYS_USER_PASS: ${{ secrets.QUALYS_USER_PASS }}
        QUALYS_PROJECT_NAME: ${{ vars.QUALYS_PROJECT_NAME }}
        QUALYS_WEBAPP_ID: ${{ vars.QUALYS_WEBAPP_ID }}
        QUALYS_OPTION_PROFILE_ID: ${{ vars.QUALYS_OPTION_PROFILE_ID }}
        QUALYS_SEND_REPORT: ${{ vars.QUALYS_SEND_REPORT }}
        QUALYS_ENCRYPT_REPORT: ${{ vars.QUALYS_ENCRYPT_REPORT }}
        QUALYS_ENCRYPT_PASS: ${{ secrets.QUALYS_ENCRYPT_PASS }}
        QUALYS_REPORT_RECEIVERS: ${{ vars.QUALYS_REPORT_RECEIVERS }}
      run: |
        git clone https://github.com/0xtiago/qualysapi
        cd qualysapi
        chmod +x qualysapi.sh
        ./qualysapi.sh | tee -a log/qualysapi.log
    
    - name: Cleaning server server (Cloud VPS).
      continue-on-error: true
      env:
        SSH_SERVER: ${{ secrets.SSH_SERVER }}
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_KEY: ${{ secrets.SSH_KEY }}
      run: |
        parallel-ssh -H $SSH_USER@$SSH_SERVER -i -x "-i /tmp/server.key -o StrictHostKeyChecking=no" 'docker kill $(docker ps -q)'
        parallel-ssh -H $SSH_USER@$SSH_SERVER -i -x "-i /tmp/server.key -o StrictHostKeyChecking=no" 'docker system prune -a -f'
        echo "Done. Good bye!"


  
