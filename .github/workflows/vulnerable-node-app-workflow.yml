name: OWASP Vulnerable Node Application - Build Action with QUALYS WAS API scan.
on:
  push:
    branches:
      - main
    paths:
      - examples/apps/vulnerable-node-app/**
  pull_request:
    branches: 
      - main
    paths:
      - examples/apps/vulnerable-node-app/**

jobs:
  build:
    runs-on: ubuntu-latest
    environment: Qualys
    steps:
    - uses: actions/checkout@v3
    - name: Setup Ubuntu Runner
      run: |
        sudo apt update
        sudo apt install -y sshpass net-tools wget git curl p7zip-full ca-certificates qpdf ghostscript apt-transport-https software-properties-common
    
    - name: Connecting remote web server and building OWASP Vulnerable Node Application
      env:
        SSH_SERVER: ${{secrets.SSH_SERVER}}
        SSH_USER: ${{secrets.SSH_SERVER}}
        SSHPASS: ${{secrets.SSHPASS}}
      run: |
        sudo sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }} 'rm -rf NodeGoat'
        sudo sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }} 'git clone https://github.com/0xtiago/NodeGoat'
        sudo sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_SERVER }} 'cd NodeGoat && docker-compose build && docker-compose up -d'
    - name: Download qualysapi from Github and executing - Kudos to VIA team!
      env: 
        QUALYS_SCANNER_TYPE: ${{ vars.QUALYS_SCANNER_TYPE }}
        QUALYS_URL: ${{ vars.QUALYS_URL }}
        QUALYS_USER: ${{ secrets.QUALYS_USER }}
        QUALYS_USER_PASS: ${{ secrets.QUALYS_USER_PASS }}
        QUALYS_PROJECT_NAME: ${{ vars.QUALYS_PROJECT_NAME }}
        QUALYS_WEBAPP_ID: ${{ vars.QUALYS_WEBAPP_ID }}
        QUALYS_OPTION_PROFILE_ID: ${{ vars.QUALYS_OPTION_PROFILE_ID }}
        QUALYS_SEND_REPORT: ${{ vars.QUALYS_SEND_REPORT }}
        QUALYS_ENCRYPT_REPORT: ${{ vars.QUALYS_ENCRYPT_REPORT }}
        QUALYS_ENCRYPT_PASS: ${{ secrets.QUALYS_ENCRYPT_PASS }}
        QUALYS_REPORT_RECEIVERS: ${{ vars.QUALYS_REPORT_RECEIVERS }}
      run: |
        git clone https://github.com/0xtiago/qualysapi
        cd qualysapi
        chmod +x qualysapi.sh 

        echo $QUALYS_SCANNER_TYPE
        echo $QUALYS_URL
        echo $QUALYS_USER
        echo $QUALYS_USER_PASS
        echo $QUALYS_PROJECT_NAME
        echo $QUALYS_WEBAPP_ID
        echo $QUALYS_OPTION_PROFILE_ID
        echo $QUALYS_SEND_REPORT
        echo $QUALYS_ENCRYPT_REPORT
        echo $QUALYS_ENCRYPT_PASS
        echo $QUALYS_REPORT_RECEIVERS
        ./qualysapi.sh | tee -a log/qualysapi.log



  
